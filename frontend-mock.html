<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MCP Interface Mock â€” Admin + Redactor</title>
  <style>
    :root{
      --bg:#0e0f11;
      --panel:#16181c;
      --panel2:#14161a;
      --border:#262a31;
      --text:#d6d9df;
      --muted:#8a9099;
      --accent:#3fa37c;
      --danger:#d85c5c;
      --ok:#69d17a;
      --warn:#d8b15c;
    }
    *{box-sizing:border-box}
    body{
      margin:0;height:100vh;overflow:hidden;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    }
    .app{
      position:relative;height:100%;padding:24px;border:1px solid var(--border);border-radius:16px;
    }

    /* Header */
    .header{display:flex;justify-content:space-between;align-items:center;font-size:14px;color:var(--muted);}
    .logo{display:flex;gap:10px;align-items:center}
    .logo-dot{width:14px;height:14px;background:var(--accent);border-radius:4px}
    .brand{font-weight:700;font-size:22px;color:var(--text);letter-spacing:.5px;font-style:italic}
    .header-right{display:flex;align-items:center;gap:14px;}

    /* Center state */
    .center{
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      pointer-events:none;text-align:center;color:var(--muted);font-size:18px;
    }

    /* Input */
    .input-wrap{
      position:absolute;left:50%;bottom:28px;transform:translateX(-50%);
      width:min(980px, 86%);display:flex;align-items:flex-end;gap:16px;
    }
    .input-area{
      flex:1;background:var(--panel);border:1px solid var(--border);border-radius:16px;
      padding:18px;min-height:92px;color:var(--text);
    }
    .send{
      background:rgba(63,163,124,.35);border:1px solid rgba(63,163,124,.45);
      color:var(--text);border-radius:24px;padding:12px 20px;cursor:pointer;
    }

    /* Floating actions */
    .actions-left{position:absolute;left:28px;bottom:34px;display:flex;gap:14px;align-items:center;}
    .actions-right{position:absolute;right:28px;bottom:54px;display:flex;flex-direction:column;gap:12px;align-items:center;}
    .action{
      width:46px;height:46px;border-radius:50%;background:var(--panel);border:1px solid var(--border);
      display:flex;align-items:center;justify-content:center;cursor:pointer;user-select:none;
    }

    /* Small pop panels (history) */
    .mini-panel{
      position:absolute;left:0;bottom:58px;width:260px;background:var(--panel);
      border:1px solid var(--border);border-radius:14px;padding:14px;display:none;
      font-size:13px;color:var(--muted);
    }
    .mini-panel.visible{display:block}
    .mini-panel .title{font-size:13px;color:var(--text);margin-bottom:10px;opacity:.9;}
    .mini-item{padding:8px 0;border-bottom:1px solid var(--border);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .mini-item:last-child{border-bottom:none}

    /* Overlay */
    .overlay{position:absolute;inset:0;background:rgba(0,0,0,.0);display:none;}
    .overlay.visible{display:block}

    /* Modal panels shared */
    .modal{
      position:absolute;left:50%;bottom:142px;transform:translateX(-50%);
      width:min(980px, 86%);
      background:linear-gradient(180deg, rgba(22,24,28,.92), rgba(20,22,26,.92));
      border:1px solid var(--border);border-radius:18px;padding:18px 18px 16px;
      box-shadow:0 20px 60px rgba(0,0,0,.45);
      display:none;backdrop-filter: blur(8px);
    }
    .modal.visible{display:block}
    .modal-header{font-size:18px;color:var(--text);opacity:.92;margin-bottom:14px;}

    .btn{
      border-radius:26px;padding:10px 18px;cursor:pointer;font-size:12px;letter-spacing:.4px;
      border:1px solid rgba(63,163,124,.45);background:rgba(63,163,124,.25);color:var(--text);
    }
    .btn.ghost{background:rgba(63,163,124,.15);border-color:rgba(63,163,124,.30);}
    .btn.primary{background:rgba(63,163,124,.40);border-color:rgba(63,163,124,.55);}
    .btn.danger{background:rgba(216,92,92,.18);border-color:rgba(216,92,92,.35);}
    .btn.small{padding:8px 12px;border-radius:18px;font-size:11px;}

    /* Admin panel */
    .admin-grid{
      display:grid;grid-template-columns:1fr 1fr;gap:22px;font-size:13px;color:var(--muted);
      line-height:1.8;padding:4px 6px 10px;
    }
    .admin-grid .span2{grid-column:1 / -1;}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
    .row{padding:4px 0;white-space:normal;overflow:hidden;text-overflow:ellipsis;}
    .slash{color:rgba(214,217,223,.75)}
    .kbd{color:rgba(214,217,223,.85)}
    .admin-actions{display:flex;justify-content:flex-end;gap:14px;margin-top:8px;padding-right:6px;}

    /* Admin modal viewport + internal scroll */
    #adminPanel{
      max-height:calc(100vh - 220px);
      overflow:hidden;
    }
    #adminPanel.visible{
      display:flex;
      flex-direction:column;
    }
    #adminPanel .admin-grid{
      flex:1;
      min-height:0;
      overflow:auto;
      padding-right:12px;
    }
    #adminPanel .admin-actions{flex:0 0 auto;}

    /* Redactor panel */
    .redactor-grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:18px;
      align-items:start;
    }
    .card{
      border:1px solid var(--border);
      border-radius:14px;
      background:rgba(22,24,28,.55);
      padding:14px;
    }
    .card h3{
      margin:0 0 10px 0;
      font-size:13px;
      color:var(--text);
      opacity:.9;
      font-weight:600;
      letter-spacing:.2px;
    }
    label{font-size:12px;color:var(--muted);display:block;margin:10px 0 6px;}
    input[type="text"], textarea, select{
      width:100%;
      background:rgba(16,17,19,.65);
      border:1px solid var(--border);
      border-radius:10px;
      color:var(--text);
      padding:10px 10px;
      outline:none;
      font-size:12px;
    }
    textarea{min-height:90px;resize:vertical;}
    .inline{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
    }
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      border:1px solid var(--border);border-radius:999px;padding:6px 10px;
      background:rgba(16,17,19,.45);
      font-size:12px;color:var(--muted);
      user-select:none;
    }
    .pill input{accent-color: var(--accent);}
    .meter{
      display:flex;gap:10px;align-items:center;
    }
    input[type="range"]{width:100%;}
    .tiny{font-size:11px;color:var(--muted);opacity:.95;}
    .hr{height:1px;background:var(--border);margin:12px 0;}
    .right-col-controls{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
    }
    .list{
      max-height:360px;overflow:auto;padding-right:6px;
    }
    .item{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      margin-bottom:10px;
      background:rgba(16,17,19,.35);
      cursor:pointer;
    }
    .item .top{
      display:flex;justify-content:space-between;gap:10px;align-items:center;
      font-size:12px;
    }
    .badge{
      padding:4px 8px;border-radius:999px;border:1px solid var(--border);
      font-size:11px;color:var(--muted);
    }
    .score{
      color:var(--text);
      border-color:rgba(63,163,124,.35);
      background:rgba(63,163,124,.10);
    }
    .tagline{margin-top:6px;font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .muted{color:var(--muted)}
    .stack{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;margin-top:12px;}

    /* User settings panel */
    .user-settings{
      position:absolute;top:56px;right:24px;width:280px;background:var(--panel);
      border:1px solid var(--border);border-radius:14px;padding:14px;font-size:13px;color:var(--muted);
      display:none;
    }
    .user-settings.visible{display:block}
    .user-settings .title{color:var(--text);margin-bottom:10px;opacity:.9}
    .user-settings .row2{padding:6px 0;border-bottom:1px solid var(--border)}
    .user-settings .row2:last-child{border-bottom:none}

    /* Chat thread */
    .thread{
      position:absolute;
      left:50%;
      top:72px;
      transform:translateX(-50%);
      width:min(980px, 86%);
      bottom:140px;
      overflow:auto;
      padding:12px 6px 18px;
    }
    .msg{
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px 14px;
      margin:10px 0;
      background:rgba(22,24,28,.85);
    }
    .msg.user{
      background:rgba(63,163,124,.12);
      border-color:rgba(63,163,124,.25);
    }
    .msg .meta{font-size:12px;color:var(--muted);margin-bottom:8px;}
    .msg .content{white-space:pre-wrap;line-height:1.35;}
    .citations{margin-top:10px;display:flex;flex-direction:column;gap:6px;}
    .citations a{color:var(--accent);text-decoration:none;font-size:12px;}
    .citations a:hover{text-decoration:underline;}
    .thumb-grid{margin-top:10px;display:flex;flex-wrap:wrap;gap:10px;}
    .thumb{
      width:180px;border:1px solid var(--border);border-radius:12px;overflow:hidden;
      background:#0b0c0e;
    }
    .thumb img{display:block;width:100%;height:auto;}
    .thumb .cap{font-size:11px;padding:6px 8px;color:var(--muted);border-top:1px solid var(--border);}
    .err-details{margin-top:10px;}
    .err-details summary{cursor:pointer;color:var(--danger);font-size:12px;}
    .err-details pre{white-space:pre-wrap;max-height:240px;overflow:auto;background:rgba(0,0,0,.25);padding:10px;border-radius:12px;border:1px solid var(--border);}

    /* In-panel scrolling */
    .mini-panel{max-height:320px;overflow:auto;}

    /* Custom scrollbars (match chat history look) */
    .app{scrollbar-width:thin;scrollbar-color:rgba(214,217,223,.28) rgba(255,255,255,.06);}
    .app ::-webkit-scrollbar{width:10px;height:10px;}
    .app ::-webkit-scrollbar-track{background:rgba(255,255,255,.06);border-radius:999px;}
    .app ::-webkit-scrollbar-thumb{
      background:rgba(214,217,223,.24);
      border-radius:999px;
      border:2px solid rgba(0,0,0,0);
      background-clip:padding-box;
    }
    .app ::-webkit-scrollbar-thumb:hover{background:rgba(214,217,223,.34);}
  </style>
</head>
<body>
<div class="app">

  <div class="header">
    <div class="logo">
      <div class="logo-dot"></div>
      <div class="brand">Luxriot</div>
    </div>

    <div class="header-right">
      <div id="userToggle" style="cursor:pointer">Logged as Admin</div>
      <div id="topToolToggle" class="action" title="Admin tools">ðŸ§°</div>
    </div>
  </div>

  <div id="thread" class="thread"></div>
  <div id="emptyState" class="center">
    Hi Sasha, I am ready to assist and learn.
  </div>

  <!-- Left bottom actions -->
  <div class="actions-left">
    <div class="action" id="historyBtn" title="History">ðŸ•˜
      <div id="historyPanel" class="mini-panel">
        <div class="title">Chat history:</div>
        <div id="historyList"></div>
      </div>
    </div>

    <div class="action" id="toolsBtn" title="Tools">ðŸ› </div>

    <!-- NEW: Redactor panel toggle -->
    <div class="action" id="redactorBtn" title="Redactor / Annotations">âœŽ</div>
  </div>

  <div class="actions-right">
    <div class="action" title="Voice / Attach">ðŸŽ™+</div>
  </div>

  <div class="input-wrap">
    <div class="input-area" id="userInput" contenteditable="true" aria-label="User input">User input</div>
    <button class="send" id="sendBtn">SEND</button>
  </div>

  <div id="overlay" class="overlay"></div>

	  <!-- Admin tools panel -->
	  <div id="adminPanel" class="modal" role="dialog" aria-label="Administrator tools">
	    <div class="modal-header">Administrator tools:</div>
	
	    <div class="admin-grid">
	      <div class="card">
	        <h3>Runtime</h3>
	        <div class="row"><span class="slash">/</span> API base: <span class="kbd" id="adminApiBase">â€”</span></div>
	        <div class="row"><span class="slash">/</span> Docs version: <span class="kbd" id="adminDocsVersion">â€”</span></div>
	        <div class="row"><span class="slash">/</span> Datastore ready: <span class="kbd" id="adminDatastoreReady">â€”</span></div>
	        <div class="row"><span class="slash">/</span> LM Studio: <span class="kbd" id="adminLmstudioUrl">â€”</span></div>
	      </div>
	
		      <div class="card">
		        <h3>Retrieval</h3>
		        <label>Mode</label>
		        <select id="adminRetrievalMode">
		          <option value="bm25">bm25</option>
		          <option value="embedding">embedding</option>
		          <option value="hybrid">hybrid</option>
		        </select>
		        <label>Default k</label>
		        <input id="adminRetrievalK" type="number" min="1" max="25" value="8"/>
		        <div class="inline">
		          <div style="flex:1;">
	            <label>Max citations</label>
	            <input id="adminMaxCitations" type="number" min="1" max="25" value="8"/>
	          </div>
	          <div style="flex:1;">
	            <label>Max images</label>
		            <input id="adminMaxImages" type="number" min="0" max="12" value="6"/>
		          </div>
		        </div>
		        <label>Doc priority boost (soft)</label>
		        <input id="adminDocPriorityBoost" type="number" step="0.01" min="0" max="1" value="0.05"/>
		        <label>Doc priority (one per line)</label>
		        <textarea id="adminDocPriority" class="mono" style="height:120px;" placeholder="luxriot-evo-global-administration-guide&#10;luxriot-evo-monitor&#10;..."></textarea>
		
		        <details style="margin-top:10px;">
		          <summary class="tiny muted">Advanced retrieval settings</summary>
		          <div class="inline" style="margin-top:10px;">
		            <div style="flex:1;">
		              <label>Max per page</label>
		              <input id="adminMaxPerPage" type="number" min="0" max="20" value="3"/>
		            </div>
		            <div style="flex:1;">
		              <label>Max per doc</label>
		              <input id="adminMaxPerDoc" type="number" min="0" max="50" value="12"/>
		            </div>
		          </div>
		
		          <div class="hr"></div>
		
		          <div class="tiny muted">Hybrid scoring (RRF)</div>
		          <div class="inline" style="margin-top:8px;">
		            <div style="flex:1;">
		              <label>RRF k</label>
		              <input id="adminRrfK" type="number" min="1" max="200" value="60"/>
		            </div>
		            <div style="flex:1;">
		              <label>BM25 weight</label>
		              <input id="adminBm25Weight" type="number" step="0.1" min="0" max="5" value="1.0"/>
		            </div>
		            <div style="flex:1;">
		              <label>Emb weight</label>
		              <input id="adminEmbWeight" type="number" step="0.1" min="0" max="5" value="1.0"/>
		            </div>
		          </div>
		          <div class="inline">
		            <div style="flex:1;">
		              <label>BM25 candidates</label>
		              <input id="adminBm25Candidates" type="number" min="10" max="500" value="120"/>
		            </div>
		            <div style="flex:1;">
		              <label>Emb candidates</label>
		              <input id="adminEmbCandidates" type="number" min="10" max="500" value="120"/>
		            </div>
		          </div>
		        </details>
		      </div>
	
	      <div class="card span2">
	        <h3>System prompt (transparent)</h3>
	        <div class="tiny muted">
	          Required placeholder: <span class="kbd">{{context}}</span> (context is inserted at runtime)
	        </div>
	        <label>Prompt template</label>
	        <textarea id="adminSystemPrompt" class="mono" style="height:220px;"></textarea>
	
	        <details class="err-details" style="margin-top:10px;">
	          <summary>Show rendered preview (without doc context)</summary>
	          <pre id="adminPromptPreview"></pre>
	        </details>
	
	        <div class="tiny muted" id="adminSaveHint" style="margin-top:8px;"></div>
	      </div>
	
		      <div class="card">
		        <h3>LLM</h3>
		        <label>Model ID (optional; blank = auto)</label>
		        <input id="adminModelId" type="text" placeholder="e.g. mistralai/ministral-3-3b"/>
		        <label>Timeout (seconds)</label>
		        <input id="adminTimeoutS" type="number" min="10" max="600" step="5" value="180"/>
		        <label>Temperature</label>
		        <input id="adminTemperature" type="number" step="0.01" min="0" max="2" value="0.2"/>
		        <label>Max tokens</label>
		        <input id="adminMaxTokens" type="number" min="64" max="4096" value="800"/>
		      </div>
	
	      <div class="card">
	        <h3>Notes</h3>
	        <div class="tiny muted">
	          - No prompts are hardcoded in service code.<br/>
	          - This template is stored in backend settings and used for every `/chat` call.
	        </div>
	      </div>
	    </div>
	
	    <div class="admin-actions">
	      <button class="btn ghost" id="defaultsBtn">DEFAULTS</button>
	      <button class="btn" id="applyBtn">APPLY</button>
	      <button class="btn primary" id="adminOkBtn">OK</button>
	    </div>
	  </div>

  <!-- NEW: Redactor panel -->
  <div id="redactorPanel" class="modal" role="dialog" aria-label="Redactor panel">
    <div class="modal-header">Redactor panel:</div>

    <div class="redactor-grid">
      <!-- Left: annotation form -->
      <div class="card">
        <h3>Annotate last answer</h3>

        <div class="tiny muted" id="activeTarget">
          Target: <span class="kbd">last_assistant_message</span>
        </div>

        <label>Score (0â€“10)</label>
        <select id="score">
          <option value="10">10</option><option value="9">9</option><option value="8">8</option>
          <option value="7" selected>7</option><option value="6">6</option><option value="5">5</option>
          <option value="4">4</option><option value="3">3</option><option value="2">2</option>
          <option value="1">1</option><option value="0">0</option>
        </select>

        <label>Tags</label>
        <div class="inline" id="tags">
          <span class="pill"><input type="checkbox" value="correct"> correct</span>
          <span class="pill"><input type="checkbox" value="partially_correct" checked> partially_correct</span>
          <span class="pill"><input type="checkbox" value="wrong"> wrong</span>
          <span class="pill"><input type="checkbox" value="hallucination"> hallucination</span>
          <span class="pill"><input type="checkbox" value="needs_citations"> needs_citations</span>
          <span class="pill"><input type="checkbox" value="noncompliant"> noncompliant</span>
          <span class="pill"><input type="checkbox" value="style_issue"> style_issue</span>
          <span class="pill"><input type="checkbox" value="unsafe"> unsafe</span>
          <span class="pill"><input type="checkbox" value="too_long"> too_long</span>
          <span class="pill"><input type="checkbox" value="too_short"> too_short</span>
        </div>

        <div class="hr"></div>

        <label>Whatâ€™s right (keep)</label>
        <textarea id="right" placeholder="Short bullets: what is correct/useful and should remain."></textarea>

        <label>Whatâ€™s wrong (fix)</label>
        <textarea id="wrong" placeholder="Short bullets: what is incorrect/missing/misleading."></textarea>

        <label>Golden fix (optional)</label>
        <textarea id="golden" placeholder="Corrected answer (or corrected fragments). High-value training signal."></textarea>

        <label>Reviewer confidence</label>
        <div class="meter">
          <input id="confidence" type="range" min="0" max="100" value="80">
          <div class="tiny"><span id="confVal">0.80</span></div>
        </div>

        <div class="inline" style="margin-top:10px;justify-content:space-between;">
          <span class="pill">
            <input id="includeContext" type="checkbox" checked>
            include full context on export
          </span>
          <button class="btn primary" id="saveAnnotationBtn">SAVE ANNOTATION</button>
        </div>

        <div class="tiny" id="saveHint" style="margin-top:10px;opacity:.9;"></div>
      </div>

      <!-- Right: triage + export -->
      <div class="card">
        <h3>Triage & export</h3>

        <div class="right-col-controls">
          <div class="inline">
            <label style="margin:0;">Filter tag</label>
            <select id="filterTag" style="width:180px;">
              <option value="">(any)</option>
              <option value="correct">correct</option>
              <option value="partially_correct">partially_correct</option>
              <option value="wrong">wrong</option>
              <option value="hallucination">hallucination</option>
              <option value="unsafe">unsafe</option>
              <option value="needs_citations">needs_citations</option>
              <option value="noncompliant">noncompliant</option>
              <option value="style_issue">style_issue</option>
              <option value="too_long">too_long</option>
              <option value="too_short">too_short</option>
            </select>
          </div>

          <div class="inline">
            <label style="margin:0;">Sort</label>
            <select id="sortBy" style="width:160px;">
              <option value="newest" selected>newest</option>
              <option value="oldest">oldest</option>
              <option value="score_low">score (low)</option>
              <option value="score_high">score (high)</option>
            </select>
          </div>
        </div>

        <div class="hr"></div>

        <div class="list" id="annoList"></div>

        <div class="stack">
          <button class="btn ghost small" id="exportJsonlBtn">EXPORT JSONL</button>
          <button class="btn ghost small" id="exportCsvBtn">EXPORT CSV</button>
          <button class="btn danger small" id="clearBtn">CLEAR LIST</button>
          <button class="btn primary small" id="redactorOkBtn">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- User settings panel -->
  <div id="userSettings" class="user-settings">
    <div class="title">User Settings</div>
    <div class="row2"><span class="slash">/</span> Organization: YourMom</div>
    <div class="row2"><span class="slash">/</span> Mailto: admin@god.com</div>
    <div class="row2"><span class="slash">/</span> Password: *******</div>
    <div class="row2"><span class="slash">/</span> Avatar: portrait.jpg</div>
  </div>

</div>

<script>
  // ---------- Backend wiring ----------
  const apiBase = (new URLSearchParams(location.search).get('api') || 'http://localhost:8000').replace(/\/$/, '');

  // "conversation" state (also used by the redactor UI)
  const session = {
    session_id: null,
    model: { id: "LM Studio", temp: 0.2, top_k: 50, top_p: 0.85 },
    tool_context: { mcp_internet: false, mcp_luxriot_docs: true }
  };

  let lastUserMessage = "User input";
  let lastAssistantMessage = "Hi Sasha, I am ready to assist and learn.";

  const annotations = []; // in-memory only

  // ---------- UI handles ----------
  const historyPanel = document.getElementById('historyPanel');
  const historyList = document.getElementById('historyList');
  const overlay = document.getElementById('overlay');

  const thread = document.getElementById('thread');
  const emptyState = document.getElementById('emptyState');

  const adminPanel = document.getElementById('adminPanel');
  const redactorPanel = document.getElementById('redactorPanel');

  const toolsBtn = document.getElementById('toolsBtn');
  const topToolToggle = document.getElementById('topToolToggle');
  const redactorBtn = document.getElementById('redactorBtn');
  const historyBtn = document.getElementById('historyBtn');

  const userToggle = document.getElementById('userToggle');
  const userSettings = document.getElementById('userSettings');

  // Redactor fields
  const scoreEl = document.getElementById('score');
  const rightEl = document.getElementById('right');
  const wrongEl = document.getElementById('wrong');
  const goldenEl = document.getElementById('golden');
  const confidenceEl = document.getElementById('confidence');
  const confValEl = document.getElementById('confVal');
  const includeContextEl = document.getElementById('includeContext');

  const saveBtn = document.getElementById('saveAnnotationBtn');
  const saveHint = document.getElementById('saveHint');

  const annoList = document.getElementById('annoList');
  const filterTag = document.getElementById('filterTag');
  const sortBy = document.getElementById('sortBy');

	  const userInput = document.getElementById('userInput');
	  const sendBtn = document.getElementById('sendBtn');

	  // ---------- Admin settings UI ----------
	  const adminApiBaseEl = document.getElementById('adminApiBase');
	  const adminDocsVersionEl = document.getElementById('adminDocsVersion');
	  const adminDatastoreReadyEl = document.getElementById('adminDatastoreReady');
	  const adminLmstudioUrlEl = document.getElementById('adminLmstudioUrl');

	  const adminSystemPromptEl = document.getElementById('adminSystemPrompt');
	  const adminPromptPreviewEl = document.getElementById('adminPromptPreview');
	  const adminSaveHintEl = document.getElementById('adminSaveHint');

		  const adminRetrievalModeEl = document.getElementById('adminRetrievalMode');
		  const adminRetrievalKEl = document.getElementById('adminRetrievalK');
		  const adminMaxCitationsEl = document.getElementById('adminMaxCitations');
		  const adminMaxImagesEl = document.getElementById('adminMaxImages');
		  const adminDocPriorityBoostEl = document.getElementById('adminDocPriorityBoost');
		  const adminDocPriorityEl = document.getElementById('adminDocPriority');
		  const adminMaxPerPageEl = document.getElementById('adminMaxPerPage');
		  const adminMaxPerDocEl = document.getElementById('adminMaxPerDoc');
		  const adminRrfKEl = document.getElementById('adminRrfK');
		  const adminBm25WeightEl = document.getElementById('adminBm25Weight');
		  const adminEmbWeightEl = document.getElementById('adminEmbWeight');
		  const adminBm25CandidatesEl = document.getElementById('adminBm25Candidates');
		  const adminEmbCandidatesEl = document.getElementById('adminEmbCandidates');

		  const adminModelIdEl = document.getElementById('adminModelId');
		  const adminTimeoutSEl = document.getElementById('adminTimeoutS');
		  const adminTemperatureEl = document.getElementById('adminTemperature');
		  const adminMaxTokensEl = document.getElementById('adminMaxTokens');

	  let adminBundle = null; // {defaults, settings, effective}
	  let chatKDefault = 8;

	  function _linesToList(text) {
	    return String(text || '')
	      .split('\n')
	      .map((x) => x.trim())
	      .filter((x) => x.length);
	  }

	  function _renderPreview(template) {
	    const retrievalMode = adminRetrievalModeEl.value || 'bm25';
	    const retrievalK = adminRetrievalKEl.value || String(chatKDefault);
	    const docPriority = _linesToList(adminDocPriorityEl.value).join(', ');
	    const vars = {
	      docs_version: adminDocsVersionEl.textContent || '(unknown)',
	      retrieval_mode: retrievalMode,
	      retrieval_k: retrievalK,
	      doc_priority: docPriority,
	      context: '(documentation context inserted at runtime)'
	    };
	    let out = String(template || '');
	    Object.entries(vars).forEach(([k, v]) => {
	      out = out.split(`{{${k}}}`).join(String(v));
	    });
	    return out;
	  }

	  function _syncPromptPreview() {
	    if (!adminPromptPreviewEl) return;
	    adminPromptPreviewEl.textContent = _renderPreview(adminSystemPromptEl.value);
	  }

	  adminSystemPromptEl.addEventListener('input', _syncPromptPreview);
	  adminRetrievalModeEl.addEventListener('change', _syncPromptPreview);
	  adminRetrievalKEl.addEventListener('input', _syncPromptPreview);
	  adminDocPriorityEl.addEventListener('input', _syncPromptPreview);

	  async function loadAdminPanel() {
	    adminSaveHintEl.textContent = '';
	    adminApiBaseEl.textContent = apiBase;

	    let health = null;
	    try {
	      health = await apiJson('/health');
	      adminDocsVersionEl.textContent = health.docs_version ?? 'â€”';
	      adminDatastoreReadyEl.textContent = String(health.datastore_ready ?? 'â€”');
	      adminLmstudioUrlEl.textContent = health.lmstudio_base_url ?? 'â€”';
	    } catch (e) {
	      adminDocsVersionEl.textContent = 'â€”';
	      adminDatastoreReadyEl.textContent = 'â€”';
	      adminLmstudioUrlEl.textContent = 'â€”';
	    }

	    adminBundle = await apiJson('/admin/settings');
		    const effective = adminBundle.effective || {};
		    const retrieval = effective.retrieval || {};
		    const llm = effective.llm || {};

		    adminRetrievalModeEl.value = retrieval.mode || 'bm25';
		    adminRetrievalKEl.value = retrieval.k_default ?? 8;
		    adminMaxCitationsEl.value = retrieval.max_citations ?? 8;
		    adminMaxImagesEl.value = retrieval.max_images ?? 6;
		    adminDocPriorityBoostEl.value = retrieval.doc_priority_boost ?? 0.05;
		    adminDocPriorityEl.value = Array.isArray(retrieval.doc_priority) ? retrieval.doc_priority.join('\n') : '';
		    adminMaxPerPageEl.value = retrieval?.dedupe?.max_per_page ?? 3;
		    adminMaxPerDocEl.value = retrieval?.dedupe?.max_per_doc ?? 12;
		    adminRrfKEl.value = retrieval?.hybrid?.rrf_k ?? 60;
		    adminBm25WeightEl.value = retrieval?.hybrid?.bm25_weight ?? 1.0;
		    adminEmbWeightEl.value = retrieval?.hybrid?.embedding_weight ?? 1.0;
		    adminBm25CandidatesEl.value = retrieval?.hybrid?.bm25_candidates ?? 120;
		    adminEmbCandidatesEl.value = retrieval?.hybrid?.embedding_candidates ?? 120;

		    adminModelIdEl.value = llm.model ?? '';
		    adminTimeoutSEl.value = llm.timeout_s ?? 180;
		    adminTemperatureEl.value = llm.temperature ?? 0.2;
		    adminMaxTokensEl.value = llm.max_tokens ?? 800;

	    adminSystemPromptEl.value = effective.system_prompt_template || '';

	    chatKDefault = Number(retrieval.k_default ?? 8);
	    _syncPromptPreview();
	  }

	  function applyDefaultsToForm() {
	    if (!adminBundle?.defaults) return;
	    const d = adminBundle.defaults;
		    const retrieval = d.retrieval || {};
		    const llm = d.llm || {};

		    adminRetrievalModeEl.value = retrieval.mode || 'bm25';
		    adminRetrievalKEl.value = retrieval.k_default ?? 8;
		    adminMaxCitationsEl.value = retrieval.max_citations ?? 8;
		    adminMaxImagesEl.value = retrieval.max_images ?? 6;
		    adminDocPriorityBoostEl.value = retrieval.doc_priority_boost ?? 0.05;
		    adminDocPriorityEl.value = Array.isArray(retrieval.doc_priority) ? retrieval.doc_priority.join('\n') : '';
		    adminMaxPerPageEl.value = retrieval?.dedupe?.max_per_page ?? 3;
		    adminMaxPerDocEl.value = retrieval?.dedupe?.max_per_doc ?? 12;
		    adminRrfKEl.value = retrieval?.hybrid?.rrf_k ?? 60;
		    adminBm25WeightEl.value = retrieval?.hybrid?.bm25_weight ?? 1.0;
		    adminEmbWeightEl.value = retrieval?.hybrid?.embedding_weight ?? 1.0;
		    adminBm25CandidatesEl.value = retrieval?.hybrid?.bm25_candidates ?? 120;
		    adminEmbCandidatesEl.value = retrieval?.hybrid?.embedding_candidates ?? 120;

		    adminModelIdEl.value = llm.model ?? '';
		    adminTimeoutSEl.value = llm.timeout_s ?? 180;
		    adminTemperatureEl.value = llm.temperature ?? 0.2;
		    adminMaxTokensEl.value = llm.max_tokens ?? 800;

	    adminSystemPromptEl.value = d.system_prompt_template || '';
	    adminSaveHintEl.textContent = 'Loaded defaults (not yet applied).';
	    _syncPromptPreview();
	  }

	  async function applyAdminSettings() {
	    adminSaveHintEl.textContent = '';
	    const tmpl = adminSystemPromptEl.value || '';
	    if (!tmpl.includes('{{context}}')) {
	      adminSaveHintEl.textContent = 'Error: prompt template must include {{context}}.';
	      return;
	    }

		    const retrieval = {
		      mode: adminRetrievalModeEl.value || 'bm25',
		      k_default: Number(adminRetrievalKEl.value || 8),
		      max_citations: Number(adminMaxCitationsEl.value || 8),
		      max_images: Number(adminMaxImagesEl.value || 6),
		      doc_priority_boost: Number(adminDocPriorityBoostEl.value || 0),
		      dedupe: {
		        max_per_page: Number(adminMaxPerPageEl.value || 0),
		        max_per_doc: Number(adminMaxPerDocEl.value || 0)
		      },
		      hybrid: {
		        rrf_k: Number(adminRrfKEl.value || 60),
		        bm25_weight: Number(adminBm25WeightEl.value || 1.0),
		        embedding_weight: Number(adminEmbWeightEl.value || 1.0),
		        bm25_candidates: Number(adminBm25CandidatesEl.value || 120),
		        embedding_candidates: Number(adminEmbCandidatesEl.value || 120)
		      },
		      doc_priority: _linesToList(adminDocPriorityEl.value)
		    };
		    const llm = {
		      model: String(adminModelIdEl.value || '').trim(),
		      timeout_s: Number(adminTimeoutSEl.value || 180),
		      temperature: Number(adminTemperatureEl.value || 0.2),
		      max_tokens: Number(adminMaxTokensEl.value || 800)
		    };
	    const payload = {
	      settings: {
	        system_prompt_template: tmpl,
	        retrieval,
	        llm
	      }
	    };

	    try {
	      adminBundle = await apiJson('/admin/settings', { method: 'POST', body: payload });
	      const effective = adminBundle.effective || {};
	      chatKDefault = Number(effective?.retrieval?.k_default ?? retrieval.k_default ?? 8);
	      adminSaveHintEl.textContent = 'Saved. New settings apply immediately.';
	    } catch (e) {
	      adminSaveHintEl.textContent = `Save failed: ${e?.raw ? String(e.raw) : String(e)}`;
	    }
	  }

	  // Load initial settings (so chat uses server defaults)
	  (async () => {
	    try {
	      const b = await apiJson('/admin/settings');
	      adminBundle = b;
	      const k = b?.effective?.retrieval?.k_default;
	      if (typeof k === 'number') chatKDefault = k;
	    } catch (e) {
	      // Backend may be down; keep defaults.
	    }
	  })();

  function setEmptyStateVisible(visible) {
    emptyState.style.display = visible ? 'flex' : 'none';
  }

  function appendMessage({ role, content, citations = null, images = null, errorText = null }) {
    const wrap = document.createElement('div');
    wrap.className = `msg ${role === 'user' ? 'user' : 'assistant'}`;

    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.textContent = role === 'user' ? 'You' : 'Assistant';
    wrap.appendChild(meta);

    const body = document.createElement('div');
    body.className = 'content';
    body.textContent = content || '';
    wrap.appendChild(body);

    if (Array.isArray(citations) && citations.length) {
      const c = document.createElement('div');
      c.className = 'citations';
      const seen = new Set();
      citations.forEach((x) => {
        const key = `${x.doc_id}/${x.page_id}/${x.anchor || ''}`;
        if (seen.has(key)) return;
        seen.add(key);
        const a = document.createElement('a');
        const href = apiBase + x.source_path + (x.anchor ? `#${encodeURIComponent(x.anchor)}` : '');
        a.href = href;
        a.target = '_blank';
        a.rel = 'noreferrer';
        a.textContent = `${x.title} (${x.doc_id}/${x.page_id})`;
        c.appendChild(a);
      });
      wrap.appendChild(c);
    }

    if (Array.isArray(images) && images.length) {
      const g = document.createElement('div');
      g.className = 'thumb-grid';
      images.forEach((x) => {
        const card = document.createElement('a');
        card.className = 'thumb';
        card.href = apiBase + x.url;
        card.target = '_blank';
        card.rel = 'noreferrer';

        const img = document.createElement('img');
        img.loading = 'lazy';
        img.src = apiBase + x.url;
        img.alt = x.near_heading || `${x.doc_id}/${x.page_id}`;
        card.appendChild(img);

        const cap = document.createElement('div');
        cap.className = 'cap';
        cap.textContent = x.near_heading ? x.near_heading : `${x.doc_id}/${x.page_id}`;
        card.appendChild(cap);

        g.appendChild(card);
      });
      wrap.appendChild(g);
    }

    if (errorText) {
      const details = document.createElement('details');
      details.className = 'err-details';
      const summary = document.createElement('summary');
      summary.textContent = 'Show raw error';
      const pre = document.createElement('pre');
      pre.textContent = errorText;
      details.appendChild(summary);
      details.appendChild(pre);
      wrap.appendChild(details);
    }

    thread.appendChild(wrap);
    thread.scrollTop = thread.scrollHeight;
    setEmptyStateVisible(false);
  }

  async function apiJson(path, { method = 'GET', body = undefined } = {}) {
    const opts = { method, headers: {} };
    if (body !== undefined) {
      opts.headers['content-type'] = 'application/json';
      opts.body = JSON.stringify(body);
    }
    const resp = await fetch(apiBase + path, opts);
    if (!resp.ok) {
      const text = await resp.text().catch(() => '');
      const err = new Error(`HTTP ${resp.status}`);
      err.status = resp.status;
      err.raw = text;
      throw err;
    }
    return await resp.json();
  }

  async function refreshSessions() {
    historyList.innerHTML = `<div class="mini-item muted"><span class="slash">/</span> Loadingâ€¦</div>`;
    try {
      const data = await apiJson('/sessions');
      const sessions = data.sessions || [];
      historyList.innerHTML = '';

      const newItem = document.createElement('div');
      newItem.className = 'mini-item';
      newItem.innerHTML = `<span class="slash">/</span> New chat`;
      newItem.addEventListener('click', () => {
        session.session_id = null;
        thread.innerHTML = '';
        setEmptyStateVisible(true);
        historyPanel.classList.remove('visible');
      });
      historyList.appendChild(newItem);

      sessions.slice(0, 20).forEach((s) => {
        const item = document.createElement('div');
        item.className = 'mini-item';
        const slash = document.createElement('span');
        slash.className = 'slash';
        slash.textContent = '/';
        item.appendChild(slash);
        item.appendChild(document.createTextNode(` ${s.title || s.session_id}`));
        item.addEventListener('click', async () => {
          await loadSession(s.session_id);
          historyPanel.classList.remove('visible');
        });
        historyList.appendChild(item);
      });
    } catch (e) {
      historyList.innerHTML = '';
      const item = document.createElement('div');
      item.className = 'mini-item';
      item.innerHTML = `<span class="slash">/</span> Failed to load sessions`;
      historyList.appendChild(item);
    }
  }

  async function loadSession(sessionId) {
    const data = await apiJson(`/sessions/${encodeURIComponent(sessionId)}/messages`);
    session.session_id = sessionId;
    thread.innerHTML = '';
    setEmptyStateVisible(true);
    const msgs = data.messages || [];
    msgs.forEach((m) => {
      appendMessage({ role: m.role, content: m.content });
      if (m.role === 'user') lastUserMessage = m.content;
      if (m.role === 'assistant') lastAssistantMessage = m.content;
    });
    if (msgs.length) setEmptyStateVisible(false);
  }

  async function sendMessage() {
    const text = userInput.innerText.trim();
    if (!text) return;

    userInput.innerText = '';
    lastUserMessage = text;
    appendMessage({ role: 'user', content: text });

    sendBtn.disabled = true;
    sendBtn.textContent = 'â€¦';

	    try {
	      const k = Math.max(1, Math.min(25, Number(chatKDefault || 8)));
	      const payload = { message: text, k };
	      if (session.session_id) payload.session_id = session.session_id;
	      const data = await apiJson('/chat', { method: 'POST', body: payload });
      session.session_id = data.session_id;
      lastAssistantMessage = data.answer || '';
      saveHint.textContent = "Updated last answer target.";
      appendMessage({ role: 'assistant', content: data.answer || '', citations: data.citations || [], images: data.images || [] });
      refreshSessions();
    } catch (e) {
      const raw = e?.raw ? String(e.raw) : String(e);
      appendMessage({ role: 'assistant', content: 'Request failed.', errorText: raw });
    } finally {
      sendBtn.disabled = false;
      sendBtn.textContent = 'SEND';
    }
  }

  sendBtn.addEventListener('click', sendMessage);
  userInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // ---------- Modal control ----------
  function closeAllModals() {
    historyPanel.classList.remove('visible');
    adminPanel.classList.remove('visible');
    redactorPanel.classList.remove('visible');
    overlay.classList.remove('visible');
  }
  function openModal(which) {
    historyPanel.classList.remove('visible');
    adminPanel.classList.remove('visible');
    redactorPanel.classList.remove('visible');

    which.classList.add('visible');
    overlay.classList.add('visible');
  }

  historyBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    const willOpen = !historyPanel.classList.contains('visible');
    closeAllModals();
    if (willOpen) {
      historyPanel.classList.add('visible');
      refreshSessions();
    }
  });

	  toolsBtn.addEventListener('click', (e) => {
	    e.stopPropagation();
	    if (adminPanel.classList.contains('visible')) closeAllModals();
	    else {
	      openModal(adminPanel);
	      loadAdminPanel().catch((err) => {
	        adminSaveHintEl.textContent = `Failed to load settings: ${err?.raw ? String(err.raw) : String(err)}`;
	      });
	    }
	  });
	  topToolToggle.addEventListener('click', (e) => {
	    e.stopPropagation();
	    if (adminPanel.classList.contains('visible')) closeAllModals();
	    else {
	      openModal(adminPanel);
	      loadAdminPanel().catch((err) => {
	        adminSaveHintEl.textContent = `Failed to load settings: ${err?.raw ? String(err.raw) : String(err)}`;
	      });
	    }
	  });

  redactorBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    if (redactorPanel.classList.contains('visible')) closeAllModals();
    else {
      openModal(redactorPanel);
      renderList();
      saveHint.textContent = "";
    }
  });

  overlay.addEventListener('click', () => closeAllModals());
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeAllModals(); });

  // user settings (not modal)
  userToggle.addEventListener('click', (e) => {
    e.stopPropagation();
    userSettings.classList.toggle('visible');
  });

	  // Admin buttons (mock)
	  document.getElementById('adminOkBtn').addEventListener('click', closeAllModals);
	  document.getElementById('applyBtn').addEventListener('click', () => {
	    applyAdminSettings();
	    pulse(adminPanel);
	  });
	  document.getElementById('defaultsBtn').addEventListener('click', () => {
	    applyDefaultsToForm();
	    pulse(adminPanel);
	  });

  // Redactor OK
  document.getElementById('redactorOkBtn').addEventListener('click', closeAllModals);

  function pulse(el){
    el.style.transform = 'translateX(-50%) scale(0.995)';
    setTimeout(() => el.style.transform = 'translateX(-50%) scale(1)', 120);
  }

  // ---------- Redactor logic ----------
  confidenceEl.addEventListener('input', () => {
    confValEl.textContent = (confidenceEl.value/100).toFixed(2);
  });

  function getSelectedTags() {
    return Array.from(document.querySelectorAll('#tags input[type="checkbox"]:checked'))
      .map(x => x.value);
  }

  function makeId() {
    const t = new Date().toISOString();
    const n = String(annotations.length + 1).padStart(3,'0');
    return `msg_${t}_${n}`;
  }

  function resetFormLight() {
    rightEl.value = "";
    wrongEl.value = "";
    goldenEl.value = "";
    // keep score/tags/confidence as-is (faster for batch labeling)
  }

  saveBtn.addEventListener('click', () => {
    const item = {
      id: makeId(),
      ts: new Date().toISOString(),
      session_id: session.session_id,
      model: { ...session.model },
      input: {
        user: lastUserMessage,
        tool_context: { ...session.tool_context },
        attachments: []
      },
      output: { assistant: lastAssistantMessage },
      label: {
        score: Number(scoreEl.value),
        tags: getSelectedTags(),
        right: rightEl.value.trim(),
        wrong: wrongEl.value.trim(),
        golden_fix: goldenEl.value.trim(),
        reviewer_confidence: Number(confidenceEl.value)/100
      }
    };

    annotations.push(item);
    saveHint.textContent = `Saved annotation #${annotations.length}`;
    renderList();
    resetFormLight();
  });

  filterTag.addEventListener('change', renderList);
  sortBy.addEventListener('change', renderList);

  function renderList() {
    let items = [...annotations];

    const ft = filterTag.value;
    if (ft) items = items.filter(a => (a.label.tags || []).includes(ft));

    switch (sortBy.value) {
      case "oldest": items.sort((a,b) => a.ts.localeCompare(b.ts)); break;
      case "score_low": items.sort((a,b) => a.label.score - b.label.score); break;
      case "score_high": items.sort((a,b) => b.label.score - a.label.score); break;
      default: items.sort((a,b) => b.ts.localeCompare(a.ts));
    }

    if (items.length === 0) {
      annoList.innerHTML = `<div class="tiny muted">No annotations yet. Save one and the pile will begin.</div>`;
      return;
    }

    annoList.innerHTML = items.map(a => {
      const tagStr = (a.label.tags || []).slice(0,3).join(", ");
      const more = (a.label.tags || []).length > 3 ? ` +${(a.label.tags||[]).length-3}` : "";
      return `
        <div class="item" data-id="${a.id}">
          <div class="top">
            <span class="badge score">score: ${a.label.score}</span>
            <span class="badge">${new Date(a.ts).toLocaleString()}</span>
          </div>
          <div class="tagline">tags: ${tagStr}${more}</div>
          <div class="tagline">golden_fix: ${a.label.golden_fix ? "yes" : "no"}</div>
        </div>
      `;
    }).join("");

    // click to load into form for editing (simple: populate fields)
    document.querySelectorAll('.item').forEach(el => {
      el.addEventListener('click', () => {
        const id = el.getAttribute('data-id');
        const a = annotations.find(x => x.id === id);
        if (!a) return;

        scoreEl.value = String(a.label.score);
        // set tags
        document.querySelectorAll('#tags input[type="checkbox"]').forEach(cb => {
          cb.checked = (a.label.tags || []).includes(cb.value);
        });
        rightEl.value = a.label.right || "";
        wrongEl.value = a.label.wrong || "";
        goldenEl.value = a.label.golden_fix || "";
        confidenceEl.value = Math.round((a.label.reviewer_confidence || 0) * 100);
        confValEl.textContent = (confidenceEl.value/100).toFixed(2);
        saveHint.textContent = `Loaded ${id} into form (save again to create a new entry).`;
      });
    });
  }

  // ---------- Export ----------
  function downloadText(filename, text) {
    const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function toExportObjects() {
    const includeContext = includeContextEl.checked;

    return annotations.map(a => {
      if (includeContext) return a;
      // strip to essentials
      return {
        id: a.id,
        ts: a.ts,
        model: a.model,
        input: { user: a.input.user },
        output: a.output,
        label: a.label
      };
    });
  }

  document.getElementById('exportJsonlBtn').addEventListener('click', () => {
    const objs = toExportObjects();
    const jsonl = objs.map(o => JSON.stringify(o)).join("\n") + "\n";
    downloadText(`annotations_${new Date().toISOString().slice(0,10)}.jsonl`, jsonl);
  });

  function csvEscape(v) {
    const s = String(v ?? "");
    if (/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  }

  document.getElementById('exportCsvBtn').addEventListener('click', () => {
    const objs = toExportObjects();
    const header = [
      "id","ts","model_id","temp","top_k","top_p",
      "user","assistant","score","tags","right","wrong","golden_fix","reviewer_confidence"
    ];
    const rows = objs.map(o => ([
      o.id,
      o.ts,
      o.model?.id ?? "",
      o.model?.temp ?? "",
      o.model?.top_k ?? "",
      o.model?.top_p ?? "",
      o.input?.user ?? "",
      o.output?.assistant ?? "",
      o.label?.score ?? "",
      (o.label?.tags ?? []).join("|"),
      o.label?.right ?? "",
      o.label?.wrong ?? "",
      o.label?.golden_fix ?? "",
      o.label?.reviewer_confidence ?? ""
    ]).map(csvEscape).join(","));
    const csv = header.join(",") + "\n" + rows.join("\n") + "\n";
    downloadText(`annotations_${new Date().toISOString().slice(0,10)}.csv`, csv);
  });

  document.getElementById('clearBtn').addEventListener('click', () => {
    annotations.length = 0;
    renderList();
    saveHint.textContent = "Cleared annotation list.";
  });

  // Init
  renderList();
</script>
</body>
</html>
